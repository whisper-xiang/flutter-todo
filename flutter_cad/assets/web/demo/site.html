<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gstar-JS-SDK2 DEMO index</title>

    <!-- CSS Styles -->
    <style>
      /* Base styles */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        box-sizing: border-box;
      }

      /* Layout */
      #wrap {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>

  <body>
    <div id="wrap"></div>

    <!-- External SDK -->
    <script src="https://resource-cn.gstarcad.com/web-cn/prod/gstar-web-site/static/js/open-dwg/GStarSDK.js?2025-12-25%2022:34:06"></script>

    <script>
      // ========================================
      // Configuration
      // ========================================

      const CONFIG = {
        apiHost: "https://cloud.gstarcad.com",
        fileId: "F19A9E840586B0DAB88B7C21556FAA9E",
        totpSecretKey: "I5JVIQSGTKTQKSK5AV",
        sources: [
          "https://ocfs.gstarcad.com/sample/2d/46493AA66F094CF06E2B813A3255CFDA/view.ocf",
        ],
      };

      // ========================================
      // TOTP/HMAC Library Functions
      // ========================================
      /**
       * 获取基于时间的一次性密码 (TOTP)
       * @param {string} secretKey - 密钥
       * @returns {string} 生成的TOTP密码
       */
      function getTOTP(secretKey) {
        const SecretKeybf = secretKey.substring(0, 11);
        const SecretKeybt = secretKey.substring(11, 18);
        const processedKey = SecretKeybf.replace("QS", SecretKeybt);

        try {
          return calcTotp(
            decodeBase32(processedKey),
            0,
            30,
            parseInt(+new Date() / 1000),
            9
          );
        } catch (e) {
          console.error("getTOTP error ", e);
          return "";
        }
      }
      /**
       * 计算基于时间的一次性密码 (RFC 6238)
       * @param {Array} secretKey - 密钥数组
       * @param {number} epoch - 起始时间戳，默认0
       * @param {number} timeStep - 时间步长，默认30秒
       * @param {number|null} timestamp - 当前时间戳，默认为null使用当前时间
       * @param {number} codeLen - 验证码长度，默认6位
       * @param {Function} hashFunc - 哈希函数，默认SHA1
       * @param {number} blockSize - 块大小，默认64
       * @returns {string} TOTP验证码
       */
      function calcTotp(
        secretKey,
        epoch,
        timeStep,
        timestamp,
        codeLen,
        hashFunc,
        blockSize
      ) {
        if (epoch === void 0) {
          epoch = 0;
        }
        if (timeStep === void 0) {
          timeStep = 30;
        }
        if (timestamp === void 0) {
          timestamp = null;
        }
        if (codeLen === void 0) {
          codeLen = 6;
        }
        if (hashFunc === void 0) {
          hashFunc = calcSha1Hash;
        }
        if (blockSize === void 0) {
          blockSize = 64;
        }
        if (timestamp === null) timestamp = Date.now();
        // Calculate counter and HOTP
        var timeCounter = Math.floor((timestamp - epoch) / timeStep);
        var counter = [];
        for (var i = 0; i < 8; i++, timeCounter = Math.floor(timeCounter / 256))
          counter.push(timeCounter & 0xff);
        counter.reverse();
        return calcHotp(secretKey, counter, codeLen, hashFunc, blockSize);
      }
      /**
       * 计算基于HMAC的一次性密码 (RFC 4226)
       * @param {Array} secretKey - 密钥数组
       * @param {Array} counter - 计数器数组
       * @param {number} codeLen - 验证码长度，默认6位
       * @param {Function} hashFunc - 哈希函数，默认SHA1
       * @param {number} blockSize - 块大小，默认64
       * @returns {string} HOTP验证码
       */
      function calcHotp(secretKey, counter, codeLen, hashFunc, blockSize) {
        if (codeLen === void 0) {
          codeLen = 6;
        }
        if (hashFunc === void 0) {
          hashFunc = calcSha1Hash;
        }
        if (blockSize === void 0) {
          blockSize = 64;
        }
        // Check argument, calculate HMAC
        if (!(1 <= codeLen && codeLen <= 9))
          throw new RangeError("Invalid number of digits");
        var hash = calcHmac(secretKey, counter, hashFunc, blockSize);
        // Dynamically truncate the hash value
        var offset = hash[hash.length - 1] % 16;
        var val = 0;
        for (var i = 0; i < 4; i++) val |= hash[offset + i] << ((3 - i) * 8);
        val &= 0x7fffffff;
        // Extract base-10 digits
        var tenPow = 1;
        for (var i = 0; i < codeLen; i++) tenPow *= 10;
        val %= tenPow;
        // Format base-10 digits
        var s = val.toString();
        while (s.length < codeLen) s = "0" + s;
        return s;
      }
      /**
       * 计算HMAC (Hash-based Message Authentication Code)
       * @param {Array} key - 密钥数组
       * @param {Array} message - 消息数组
       * @param {Function} hashFunc - 哈希函数
       * @param {number} blockSize - 块大小
       * @returns {Array} HMAC结果数组
       */
      function calcHmac(key, message, hashFunc, blockSize) {
        if (blockSize < 1) throw new RangeError("Invalid block size");
        if (key.length > blockSize) key = hashFunc(key);
        var newKey = key.slice();
        while (newKey.length < blockSize) newKey.push(0x00);
        var innerMsg = newKey.map(function (b) {
          return b ^ 0x36;
        });
        for (var _i = 0, message_1 = message; _i < message_1.length; _i++) {
          var b = message_1[_i];
          innerMsg.push(b);
        }
        var innerHash = hashFunc(innerMsg);
        var outerMsg = newKey.map(function (b) {
          return b ^ 0x5c;
        });
        for (
          var _a = 0, innerHash_1 = innerHash;
          _a < innerHash_1.length;
          _a++
        ) {
          var b = innerHash_1[_a];
          outerMsg.push(b);
        }
        return hashFunc(outerMsg);
      }
      /**
       * 计算SHA1哈希值
       * @param {Array} message - 消息数组
       * @returns {Array} SHA1哈希结果数组
       */
      function calcSha1Hash(message) {
        var bitLenBytes = [];
        for (var i = 0, bitLen = message.length * 8; i < 8; i++, bitLen >>>= 8)
          bitLenBytes.push(bitLen & 0xff);
        bitLenBytes.reverse();
        var msg = message.slice();
        msg.push(0x80);
        while ((msg.length + 8) % 64 != 0) msg.push(0x00);
        for (
          var _i = 0, bitLenBytes_1 = bitLenBytes;
          _i < bitLenBytes_1.length;
          _i++
        ) {
          var b = bitLenBytes_1[_i];
          msg.push(b);
        }
        var state = [
          0x67452301, 0xefcdab89, 0x98badcfe, 0x10325476, 0xc3d2e1f0,
        ];
        var _loop_1 = function (i) {
          var schedule = [];
          for (var j = 0; j < 64; j++) {
            if (j % 4 == 0) schedule.push(0);
            schedule[Math.floor(j / 4)] |= msg[i + j] << ((3 - (j % 4)) * 8);
          }
          for (var j = schedule.length; j < 80; j++) {
            var temp =
              schedule[j - 3] ^
              schedule[j - 8] ^
              schedule[j - 14] ^
              schedule[j - 16];
            schedule.push((temp << 1) | (temp >>> 31));
          }
          var a = state[0],
            b = state[1],
            c = state[2],
            d = state[3],
            e = state[4];
          schedule.forEach(function (sch, j) {
            var f, rc;
            switch (Math.floor(j / 20)) {
              case 0:
                f = (b & c) | (~b & d);
                rc = 0x5a827999;
                break;
              case 1:
                f = b ^ c ^ d;
                rc = 0x6ed9eba1;
                break;
              case 2:
                f = (b & c) ^ (b & d) ^ (c & d);
                rc = 0x8f1bbcdc;
                break;
              case 3:
                f = b ^ c ^ d;
                rc = 0xca62c1d6;
                break;
              default:
                throw new Error("Assertion error");
            }
            var temp = (((a << 5) | (a >>> 27)) + f + e + sch + rc) >>> 0;
            e = d;
            d = c;
            c = (b << 30) | (b >>> 2);
            b = a;
            a = temp;
          });
          state[0] = (state[0] + a) >>> 0;
          state[1] = (state[1] + b) >>> 0;
          state[2] = (state[2] + c) >>> 0;
          state[3] = (state[3] + d) >>> 0;
          state[4] = (state[4] + e) >>> 0;
        };
        for (var i = 0; i < msg.length; i += 64) {
          _loop_1(i);
        }
        var result = [];
        for (var _a = 0, state_1 = state; _a < state_1.length; _a++) {
          var val = state_1[_a];
          for (var i = 3; i >= 0; i--) result.push((val >>> (i * 8)) & 0xff);
        }
        return result;
      }
      /**
       * 解码Base32字符串
       * @param {string} str - Base32编码的字符串
       * @returns {Array} 解码后的字节数组
       */
      function decodeBase32(str) {
        var ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
        var result = [];
        var bits = 0;
        var bitsLen = 0;
        for (var _i = 0, str_1 = str; _i < str_1.length; _i++) {
          var c = str_1[_i];
          if (c == " ") continue;
          var i = ALPHABET.indexOf(c.toUpperCase());
          if (i == -1) throw new RangeError("Invalid Base32 string");
          bits = (bits << 5) | i;
          bitsLen += 5;
          if (bitsLen >= 8) {
            bitsLen -= 8;
            result.push(bits >>> bitsLen);
            bits &= (1 << bitsLen) - 1;
          }
        }
        return result;
      }

      // ========================================
      // Data Definitions
      // ========================================

      // Sample notes data (would normally be loaded from API)
      // const SAMPLE_NOTES = [
      //   {
      //     id: 1874920,
      //     status: 0,
      //     creator: 116310079,
      //     createDate: "2025-11-19 17:19:10",
      //     lastModifier: 116310079,
      //     lastModifyDate: "2025-11-19 17:19:10",
      //     fileId: 7330227,
      //     clientType: "DF_iOS",
      //     appVersion: "5.16.4",
      //     noteType: "HCNotePicture",
      //     changeCount: 0,
      //     noteVersion: 4,
      //     attachSize: 125947,
      //     localCreateTime: "2025-11-19 17:18:44",
      //     localTime: 1763543924,
      //     content: {
      //       spacename: "1F",
      //       linecolor: 240,
      //       position: "687.1882,732.9937,0.0000",
      //       layoutname: "Model",
      //       content: [
      //         {
      //           path: "820_1763543932000_15.jpg",
      //           fileSize: 125947,
      //           fileKey: "/2025/11/19/820_1763543932000_15.jpg",
      //           comment: "",
      //           data: "data:application/octet-stream;base64,/9j/4AAQSkZJRgABAQAASABIAAD/4QCARXhpZgAATU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAKgAgAEAAAAAQAAAzygAwAEAAAAAQAABFAAAAAA/+0AOFBob3Rvc2hvcCAzLjAAOEJJTQQEAAAAAAAAOEJJTQQlAAAAAAAQ1B2M2Y8AsgTpgAmY7PhCfv/iAihJQ0NfUFJPRklMRQABAQAAAhhhcHBsBAAAAG1udHJSR0IgWFlaIAfmAAEAAQAAAAAAAGFjc3BBUFBMAAAAAEFQUEwAAAAAAAAAAAAAAAAAAAAAAAD21gABAAAAANMtYXBwbOz9o444hUfDbbS9T3raGC8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACmRlc2MAAAD8AAAAMGNwcnQAAAEsAAAAUHd0cHQAAAF8AAAAFHJYWVoAAAGQAAAAFGdYWVoAAAGkAAAAFGJYWVoAAAG4AAAAFHJUUkMAAAHMAAAAIGNoYWQAAAHsAAAALGJUUkMAAAHMAAAAIGdUUkMAAAHMAAAAIG1sdWMAAAAAAAAAAQAAAAxlblVTAAAAFAAAABwARABpAHMAcABsAGEAeQAgAFAAM21sdWMAAAAAAAAAAQAAAAxlblVTAAAANAAAABwAQwBvAHAAeQByAGkAZwBoAHQAIABBAHAAcABsAGUAIABJAG4AYwAuACwAIAAyADAAMgAyWFlaIAAAAAAAAPbVAAEAAAAA0yxYWVogAAAAAAAAg98AAD2/////u1hZWiAAAAAAAABKvwAAsTcAAAq5WFlaIAAAAAAAACg4AAARCwAAyLlwYXJhAAAAAAADAAAAAmZmAADypwAADVkAABPQAAAKW3NmMzIAAAAAAAEMQgAABd7///MmAAAHkwAA/ZD///ui///9owAAA9wAAMBu/8AAEQgEUAM8AwEiAAIRAQMRAf/EAB8AAAEFAQEBAQEBAAAAAAAAAAABAgMEBQYHCAkKC//EALUQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+v/EAB8BAAMBAQEBAQEBAQEAAAAAAAABAgMEBQYHCAkKC//EALURAAIBAgQEAwQHBQQEAAECdwABAgMRBAUhMQYSQVEHYXETIjKBCBRCkaGxwQkjM1LwFWJy0QoWJDThJfEXGBkaJicoKSo1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoKDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uLj5OXm5+jp6vLz9PX29/j5+v/bAEMABgYGBgYGCgYGCg4KCgoOEg4ODg4SFxISEhISFxwXFxcXFxccHBwcHBwcHCIiIiIiIicnJycnLCwsLCwsLCwsLP/bAEMBBwcHCwoLEwoKEy4fGh8uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLv/dAAQANP/aAAwDAQACEQMRAD8A+gyMUYp+2nAVxDI8Uo+WpBSbeaAGAZpwUGn7RijFAEQHNLin4p22gCPFAHapdtLspgRbaOnNSbaXbSAhA60u30qbbxRtwM0wIdtLtqXaKMYosAzF...[165995 bytes truncated]",
      //         },
      //       ],
      //     },
      //     userId: 116310079,
      //     isTransfer: 0,
      //     state: 1,
      //     localId: 2,
      //   },
      //   {
      //     id: 1874928,
      //     status: 0,
      //     creator: 116310079,
      //     createDate: "2025-11-21 15:57:37",
      //     lastModifier: 116310079,
      //     lastModifyDate: "2025-11-21 15:57:37",
      //     fileId: 7330227,
      //     clientType: "DF_iOS",
      //     appVersion: "5.16.4",
      //     noteType: "HCNoteVideo",
      //     changeCount: 0,
      //     noteVersion: 4,
      //     attachSize: 1833860,
      //     localCreateTime: "2025-11-21 15:56:20",
      //     localTime: 1763711780,
      //     content: {
      //       spacename: "1F",
      //       linecolor: 240,
      //       position: "722.0498,494.4668,0.0000",
      //       layoutname: "Model",
      //       content: [
      //         {
      //           coverKey: "/2025/11/21/599_1763711797000_69.jpg",
      //           path: "599_1763711797000_69.mp4",
      //           coverPath: "599_1763711797000_69.jpg",
      //           fileSize: 1833860,
      //           fileKey: "/2025/11/21/599_1763711797000_69.mp4",
      //           comment: "",
      //           second: 8.866666793823242,
      //           videoUrl:
      //             "https://gstarcad-note-offline-cn.51ake.com/test/2025/11/21/599_1763711797000_69.mp4?auth_key=1764327141-0-0-a9461a6a64d5d0e3d82f08b1a5ac5916&response-content-disposition=attachment%3B%20filename%3D",
      //           coverData:
      //             "data:application/octet-stream;base64,/9j/4AAQSkZJRgABAQAASABIAAD/4QCARXhpZgAATU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAKgAgAEAAAAAQAAAeCgAwAEAAAAAQAAAoAAAAAA/+0AOFBob3Rvc2hvcCAzLjAAOEJJTQQEAAAAAAAAOEJJTQQlAAAAAAAQ1B2M2Y8AsgTpgAmY7PhCfv/iAohJQ0NfUFJPRklMRQABAQAAAnhhcHBsAhAAAG1udHJSR0IgWFlaIAfVAAQAAQABAAEAAWFjc3BBUFBMAAAAAEFQUEwAAAAAAAAAAAAAAAAAAAAAAAD21gABAAAAANMtYXBwbAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC2Rlc2MAAAEIAAAAeWNwcnQAAAGEAAAAInd0cHQAAAGoAAAAFHJYWVoAAAG8AAAAFGdYWVoAAAHQAAAAFGJYWVoAAAHkAAAAFHJUUkMAAAH4AAAADnZjZ3QAAAIIAAAAMG5kaW4AAAI4AAAAPmJUUkMAAAH4AAAADmdUUkMAAAH4AAAADmRlc2MAAAAAAAAAH1F1aWNrVGltZSAnbmNsYycgVmlkZW8gKDEsMSw2KQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB0ZXh0AAAAAENvcHlyaWdodCAyMDA3IEFwcGxlIEluYy4AAABYWVogAAAAAAAA81EAAQAAAAEWzFhZWiAAAAAAAABvogAAOPUAAAOQWFlaIAAAAAAAAGKZAAC3hQAAGNpYWVogAAAAAAAAJKAAAA+EAAC2z2N1cnYAAAAAAAAAAQH2AAB2Y2d0AAAAAAAAAAEAAQAAAAAAAAABAAAAAQAAAAAAAAABAAAAAQAAAAAAAAABAABuZGluAAAAAAAAADYAAKPXAABUewAATM0AAJmaAAAmZgAAD1wAAFANAABUOQAB9gQAAfYEAAH2BAAAAAAAAAAA/8AAEQgCgAHgAwEiAAIRAQMRAf/EAB8AAAEFAQEBAQEBAAAAAAAAAAABAgMEBQYHCAkKC//EALUQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+v/EAB8BAAMBAQEBAQEBAQEAAAAAAAABAgMEBQYHCAkKC//EALURAAIBAgQEAwQHBQQEAAECdwABAgMRBAUhMQYSQVEHYXETIjKBCBRCkaGxwQkjM1LwFWJy0QoWJDThJfEXGBkaJicoKSo1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoKDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uLj5OXm5+jp6vLz9PX29/j5+v/bAEMABgYGBgYGCgYGCg4KCgoOEg4ODg4SFxISEhISFxwXFxcXFxccHBwcHBwcHCIiIiIiIicnJycnLCwsLCwsLCwsLP/bAEMBBwcHCwoLEwoKEy4fGh8uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLv/dAAQAHv/aAAwD...[40323 bytes truncated]",
      //         },
      //       ],
      //     },
      //     userId: 116310079,
      //     isTransfer: 0,
      //     state: 1,
      //     localId: 3,
      //   },
      // ];

      // ========================================
      // SDK Initialization
      // =========================================

      const wrap = document.getElementById("wrap");
      const gstarSDK = new GStarSDK({
        // Required
        wrapId: "wrap",
        apiHeader: {
          test: "test",
        },
        /**
         * 布局切换回调函数
         */
        switchLayoutCB: () => {},
        apiHost: CONFIG.apiHost,

        // Optional settings
        mobileSizeLimit: 5242880,
        pcSizeLimit: 12582912,
        mode: "default",
        language: "zh",
        apiNameOfSaveAs: "/testsad",
        hideToolbar: false,
        textSearchScale: 1,
        toolbarHideItems: {},
        notesIsMesh: true,
        zoomBasic: 0.8,

        // // Callbacks
        // /**
        //  * 注释选择回调函数
        //  * @param {Object} noteData - 注释数据
        //  * @returns {boolean} 是否允许选择
        //  */
        // notesSelectCB: function (noteData) {
        //   console.log("noteData", noteData);
        //   localStorage.setItem("note", JSON.stringify(noteData));
        //   return true;
        // },

        // /**
        //  * 权限检查函数
        //  * @param {string} funcName - 功能名称
        //  * @returns {boolean} 是否有权限
        //  */
        // hasPermission: (funcName) => {
        //   const restrictedList = ["print", "noteArrow"];
        //   return !restrictedList.includes(funcName);
        // },
      });

      // Enable features
      // gstarSDK.enableZoom(5); // Mouse wheel zoom (speed = 5)
      // gstarSDK.enablePan(); // Mouse left button/wheel pan
      // gstarSDK.disableMap(); // Disable minimap

      // Measurement accuracy
      // gstarSDK.measures.accuracy = 3;

      // API configuration
      // gstarSDK.apiHost = window.location.protocol + "//" + window.location.host;
      // gstarSDK.apiHeader = {
      //   Authorization: "xxxxx",
      //   Myheader: "123123123",
      // };

      // Custom API endpoints
      // gstarSDK.apiRename.saveAs = "/saveAsdwg?key=5427&cad=test";
      // gstarSDK.apiRename.saveAsPdf = "/saveAsPdf?key=5427&cad=test";

      // ========================================
      // Event Handlers
      // ========================================

      /**
       * 另存为完成事件处理器
       * @param {string} eventName - 事件名称
       * @param {*} data - 返回的数据
       */
      gstarSDK.on("saveAs.finish", (eventName, data) => {
        console.log("Save As completed:", data);
      });

      /**
       * 截图完成事件处理器
       * @param {string} eventName - 事件名称
       * @param {*} data - 返回的图片数据
       */
      gstarSDK.on("saveImage.finish", (eventName, data) => {
        console.log("Screenshot completed:", data);
      });

      /**
       * PDF导出完成事件处理器
       * @param {string} eventName - 事件名称
       * @param {*} data - 返回的PDF数据
       */
      gstarSDK.on("savePDF.finish", (eventName, data) => {
        console.log("PDF export completed:", data);
      });

      /**
       * 注释变更事件处理器
       * @param {string} msg - 消息
       * @param {*} data - 注释数据
       */
      gstarSDK.on("noteChange", (msg, data) => {
        console.log("Note changed:", msg, JSON.stringify(data));
      });

      /**
       * 功能触发事件处理器
       * @param {string} eventName - 事件名称
       * @param {string} functionName - 触发的功能名称
       */
      gstarSDK.on("functionTrigger", (eventName, functionName) => {
        console.log("Function triggered:", functionName);
      });

      // ========================================
      // Utility Functions
      // ========================================

      /**
       * 读取文件的前16个字节并解析版本信息
       * @param {ArrayBuffer} arrayBuffer - 文件数据缓冲区
       */
      function readFirst16Bytes(arrayBuffer) {
        arrayBuffer = arrayBuffer.slice(0, 16);
        const view = new DataView(arrayBuffer);
        const magic = new TextDecoder().decode(
          new Uint8Array(arrayBuffer, 0, 8)
        );
        const version = view.getUint16(8, true); // Little-endian at offset 8
        console.log("OCF-Version:", version);
      }

      // ========================================
      // Application Initialization
      // ========================================

      /**
       * 初始化应用程序
       * 加载图纸数据并渲染显示
       */
      function initializeApp() {
        getDrawSheet(CONFIG.sources[0], async function (buffer0) {
          const buf0 = buffer0.slice(0);
          const buf1 = buffer0.slice(0);
          readFirst16Bytes(buf1);

          const code = getTOTP(CONFIG.totpSecretKey);
          gstarSDK.setDynamicPW(code);
          gstarSDK.render("ocf", buf0, "31621332", true);

          // Show sample notes after 3 seconds
          // setTimeout(() => {
          //   gstarSDK.notes.show(SAMPLE_NOTES);
          // }, 3000);
        });
      }

      // Start the application
      initializeApp();

      // ========================================
      // Network Utility
      // ========================================

      /**
       * 获取图纸数据
       * @param {string} url - 图纸文件URL
       * @param {Function} callback - 回调函数，接收文件数据
       * @param {string} method - HTTP请求方法，默认GET
       */
      function getDrawSheet(url, callback, method = "GET") {
        const xhr = window.XMLHttpRequest
          ? new XMLHttpRequest()
          : new ActiveXObject("Microsoft.XMLHTTP");

        /**
         * HTTP请求加载完成回调函数
         */
        xhr.onload = function () {
          if ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 304) {
            callback(xhr.response);
          } else if (xhr.status === 404) {
            callback(null);
          }
        };

        xhr.open(method, url, true);
        xhr.responseType = "arraybuffer";
        xhr.send(null);
      }
    </script>
  </body>
</html>
